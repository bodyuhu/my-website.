<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ضاغط الصور — تم التطوير بواسطة abdo</title>
  <style>
    :root{--bg:#0f172a;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8}
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{margin:0;background:linear-gradient(180deg,#071029 0%,#081229 100%);color:#e6eef6;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px}
    .container{width:100%;max-width:980px;background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));border-radius:12px;padding:18px;box-shadow:0 8px 30px rgba(2,6,23,0.7)}
    header{display:flex;align-items:center;gap:12px}
    header h1{margin:0;font-size:20px}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:14px}
    .card{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px}
    .drop{min-height:300px;border:2px dashed rgba(255,255,255,0.06);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px;padding:18px;border-radius:8px}
    .thumb{max-width:100%;height:auto;border-radius:6px;box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    input[type=file]{display:none}
    .btn{background:var(--accent);color:#001219;padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
    .row{display:flex;gap:10px;align-items:center}
    label.range{display:flex;flex-direction:column;gap:6px}
    .info{font-size:13px;color:var(--muted)}
    footer{margin-top:12px;text-align:center;color:var(--muted);font-size:13px}
    .progress{height:10px;background:rgba(255,255,255,0.03);border-radius:6px;overflow:hidden}
    .progress > i{display:block;height:100%;width:0;background:linear-gradient(90deg,rgba(255,255,255,0.08),rgba(255,255,255,0.18));}
    .small{font-size:12px;color:var(--muted)}
    @media (max-width:920px){.grid{grid-template-columns:1fr;}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36'><rect rx='8' width='36' height='36' fill='%2306b6d4'/><text x='50%' y='54%' font-size='18' text-anchor='middle' fill='%23001212' font-family='Arial' font-weight='700'>A</text></svg>" alt="logo" style="width:44px;height:44px;border-radius:8px;box-shadow:0 6px 18px rgba(2,6,23,0.5)">
      <div>
        <h1>ضاغط الصور — سريع واحترافي</h1>
        <div class="info">اضغط صورك مباشرة في المتصفح — لا يحتاج سيرفر — تم التطوير بواسطة <strong>abdo</strong></div>
      </div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="drop" id="dropZone">
          <div style="text-align:center;max-width:420px">
            <p class="small">اسحب الصورة هنا أو اضغط زر التحميل</p>
            <button class="btn" id="pickBtn">اختر صورة</button>
            <input id="fileInput" type="file" accept="image/*">
          </div>
          <div id="previewWrap" style="display:none;width:100%">
            <img id="preview" class="thumb" alt="معاينة الصورة">
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <div class="row" style="flex:1;gap:8px">
            <label class="range">
              <span class="small">جودة الصورة: <span id="qualityVal">0.8</span></span>
              <input id="quality" type="range" min="0.1" max="1" step="0.05" value="0.8">
            </label>
          </div>
          <div class="row">
            <button class="btn" id="compressBtn" disabled>اضغط الآن</button>
            <button class="btn" id="downloadBtn" style="display:none">تحميل المضغوط</button>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <div class="small">حجم أصلي: <strong id="origSize">-</strong></div>
          <div class="small">حجم مضغوط: <strong id="newSize">-</strong></div>
        </div>

        <div style="margin-top:12px">
          <div class="progress"><i id="progBar"></i></div>
        </div>

      </section>

      <aside class="card">
        <h3 style="margin-top:0">الخيارات المتقدمة</h3>
        <div class="info">يمكنك تغيير الجودة أو تحويل الصيغة (سيحاول المتصفح دعم webp إذا رغبت)</div>

        <div style="margin-top:12px">
          <label class="small">صيغة الإخراج
            <select id="outFormat" style="width:100%;margin-top:8px;padding:8px;border-radius:6px;background:transparent;color:inherit;border:1px solid rgba(255,255,255,0.03)">
              <option value="auto">افتراضي (احتفظ بالصيغة أو webp إن أمكن)</option>
              <option value="jpeg">JPEG</option>
              <option value="png">PNG</option>
              <option value="webp">WebP</option>
            </select>
          </label>
        </div>

        <div style="margin-top:12px">
          <label class="small">عرض أقصى (px)
            <input id="maxWidth" type="number" min="0" placeholder="مثلاً 1200" style="width:100%;margin-top:8px;padding:8px;border-radius:6px;background:transparent;color:inherit;border:1px solid rgba(255,255,255,0.03)">
          </label>
        </div>

        <div style="margin-top:14px;font-size:13px;color:var(--muted)">
          تعليمات: اختر صورة، ضبط الجودة، ثم اضغط "اضغط الآن". الصورة تُعالج محليًا في المتصفح.
        </div>

      </aside>
    </div>

    <footer>تم التطوير بواسطة <strong>abdo</strong> • صمم للعمل محلياً وفي الخادم</footer>
  </div>

  <script src="https://unpkg.com/browser-image-compression@1.0.15/dist/browser-image-compression.js"></script>
  <script>
    // عناصر
    const pickBtn = document.getElementById('pickBtn');
    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('preview');
    const previewWrap = document.getElementById('previewWrap');
    const compressBtn = document.getElementById('compressBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const quality = document.getElementById('quality');
    const qualityVal = document.getElementById('qualityVal');
    const origSize = document.getElementById('origSize');
    const newSize = document.getElementById('newSize');
    const outFormat = document.getElementById('outFormat');
    const maxWidth = document.getElementById('maxWidth');
    const progBar = document.getElementById('progBar');
    const dropZone = document.getElementById('dropZone');

    let currentFile;
    let compressedBlob;

    function fmtBytes(bytes){
      if(!bytes) return '-';
      const units=['B','KB','MB','GB'];
      let i=0; while(bytes>=1024 && i<units.length-1){bytes/=1024; i++;}
      return bytes.toFixed(2)+' '+units[i];
    }

    pickBtn.addEventListener('click',()=>fileInput.click());
    fileInput.addEventListener('change',e=>handleFiles(e.target.files));

    // drag & drop
    ['dragenter','dragover'].forEach(evt=>{
      dropZone.addEventListener(evt,e=>{e.preventDefault();dropZone.style.borderColor='rgba(255,255,255,0.18)';});
    });
    ['dragleave','drop'].forEach(evt=>{
      dropZone.addEventListener(evt,e=>{e.preventDefault();dropZone.style.borderColor='rgba(255,255,255,0.06)';});
    });
    dropZone.addEventListener('drop',e=>{
      if(e.dataTransfer.files && e.dataTransfer.files.length) handleFiles(e.dataTransfer.files);
    });

    function handleFiles(files){
      const file = files[0];
      if(!file) return;
      if(!file.type.startsWith('image/')) {alert('الملف ليس صورة');return}
      currentFile = file;
      previewWrap.style.display = 'block';
      preview.src = URL.createObjectURL(file);
      origSize.textContent = fmtBytes(file.size);
      newSize.textContent = '-';
      compressedBlob = null;
      compressBtn.disabled = false;
      downloadBtn.style.display = 'none';
      progBar.style.width = '0%';
    }

    quality.addEventListener('input',()=>{qualityVal.textContent = quality.value});

    compressBtn.addEventListener('click',async ()=>{
      if(!currentFile) return;
      compressBtn.disabled = true;
      progBar.style.width = '4%';

      const options = {
        maxSizeMB: 2,
        maxWidthOrHeight: maxWidth.value ? parseInt(maxWidth.value) : undefined,
        useWebWorker: true,
        initialQuality: parseFloat(quality.value)
      };

      // force mime type based on selection
      const format = outFormat.value;
      if(format === 'jpeg') options.fileType = 'image/jpeg';
      else if(format === 'png') options.fileType = 'image/png';
      else if(format === 'webp') options.fileType = 'image/webp';

      try{
        const onProgress = (p)=>{ progBar.style.width = Math.min(98, Math.round(p)) + '%'; };
        const compressedFile = await imageCompression(currentFile, {...options, onProgress});
        compressedBlob = compressedFile;
        newSize.textContent = fmtBytes(compressedFile.size);
        progBar.style.width = '100%';
        downloadBtn.style.display = 'inline-block';
        downloadBtn.onclick = ()=>{
          const a = document.createElement('a');
          a.href = URL.createObjectURL(compressedBlob);
          const ext = (compressedBlob.type.split('/')[1] || 'jpg');
          a.download = (currentFile.name.replace(/\.[^/.]+$/, '') + '-compressed.' + ext);
          document.body.appendChild(a); a.click(); a.remove();
        }
      }catch(err){
        console.error(err);
        alert('حدث خطأ أثناء الضغط — تأكد من نوع الملف وحاول مجدداً');
      }finally{
        compressBtn.disabled = false;
      }
    });

  </script>
</body>
</html>
